<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANATOMLE | Clinical 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=EB+Garamond&display=swap');
        body { margin: 0; background: #050505; color: #d6d3d1; font-family: 'EB Garamond', serif; overflow: hidden; }
        .ui-panel { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(15px); border-right: 1px solid #222; z-index: 10; }
        .glitch-text { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.05em; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>
    <div id="ui-layer" class="fixed inset-0 pointer-events-none flex">
        <div class="w-85 p-6 flex flex-col pointer-events-auto ui-panel border-r border-stone-800">
            <h1 class="glitch-text text-4xl text-white mb-1">ANATOMLE</h1>
            <p class="text-[10px] text-stone-500 uppercase tracking-[0.3em] mb-8 border-b border-stone-800 pb-4">Clinical Pathway v24.3</p>
            
            <div id="path-container" class="flex-1 overflow-y-auto space-y-3 mb-6 pr-2 custom-scrollbar">
                </div>

            <div class="space-y-4">
                <div class="p-4 bg-stone-900/50 rounded border border-stone-700">
                    <p class="text-[10px] text-stone-500 uppercase mb-2 font-bold italic">Diagnostic Target</p>
                    <div class="flex justify-between items-center">
                        <span id="target-name" class="font-bold uppercase text-white tracking-tight text-sm">Sacrum</span>
                        <span class="text-emerald-500">ðŸŽ¯</span>
                    </div>
                </div>

                <div class="relative">
                    <input id="guess-input" type="text" placeholder="Search structures..." 
                        class="w-full bg-black border border-stone-800 p-4 rounded-lg italic text-white outline-none focus:border-emerald-500 transition-colors">
                    <div id="suggestions" class="absolute bottom-full left-0 w-full bg-stone-900 border border-stone-700 rounded-t-lg hidden mb-1 overflow-hidden z-20"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GAME DATA & MAPPING ---
        // Mapping common names to the internal GLB names from your screenshots
        const BONE_LOOKUP = {
            "Sacrum": "Sacrum",
            "Frontal Bone": "Frontal_bone",
            "Femur": "Femurr",
            "Tibia": "Tibiar",
            "Mandible": "Mandible_bone",
            "Atlas": "Atlas_(C1)",
            "Axis": "Axis_(C2)",
            "Sternum": "Body_of_sternum",
            "Radius": "Radiusr",
            "Ulna": "Ulnar"
        };

        const targetBone = "Sacrum";
        let guessChain = [];

        // --- 2. THREE.JS ENGINE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(0, 1, 5);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 5);
        scene.add(light);

        // Draco Fix
        const dracoLoader = new THREE.DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        const loader = new THREE.GLTFLoader();
        loader.setDRACOLoader(dracoLoader);

        let skeletonModel = null;
        loader.load('./overview-skeleton.glb', (gltf) => {
            skeletonModel = gltf.scene;
            scene.add(skeletonModel);
            updateVisuals();
        });

        // --- 3. THE "SWAP/AHEAD" LOGIC INTEGRATION ---
        function getBoneStatus(guess) {
            if (guess.toLowerCase() === targetBone.toLowerCase()) return { emoji: 'âœ…', color: 0x10b981 };
            
            // Simulation of "Swap" (Yellow) vs "Ahead" (Blue) logic
            // In the full game, this would check your Graph connectivity
            const isRelated = ["Frontal Bone", "Mandible"].includes(guess);
            return isRelated ? { emoji: 'ðŸ”€', color: 0xf59e0b } : { emoji: 'ðŸ§¬', color: 0x3b82f6 };
        }

        function updateVisuals() {
            if (!skeletonModel) return;
            skeletonModel.traverse((node) => {
                if (node.isMesh) {
                    // Match by name or name+'r'
                    const guessData = guessChain.find(g => 
                        BONE_LOOKUP[g.name] === node.name || (BONE_LOOKUP[g.name] + 'r') === node.name
                    );

                    if (guessData) {
                        node.material = new THREE.MeshStandardMaterial({
                            color: guessData.color,
                            emissive: guessData.color,
                            emissiveIntensity: 0.4
                        });
                    } else {
                        node.material = new THREE.MeshStandardMaterial({
                            color: 0x222222,
                            transparent: true,
                            opacity: 0.15
                        });
                    }
                }
            });
        }

        // --- 4. UI HANDLERS ---
        const input = document.getElementById('guess-input');
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value) {
                const val = input.value.trim();
                const status = getBoneStatus(val);
                
                guessChain.push({ name: val, ...status });
                
                const item = document.createElement('div');
                item.className = "p-4 bg-stone-900 border border-stone-800 rounded flex justify-between items-center text-xs font-bold uppercase tracking-widest text-white";
                item.innerHTML = `<span>${val}</span><span style="color: #${status.color.toString(16)}">${status.emoji}</span>`;
                document.getElementById('path-container').prepend(item);
                
                input.value = '';
                updateVisuals();
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
