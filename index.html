<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANATOMLE | test Clinical 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=EB+Garamond&display=swap');
        body { margin: 0; background: #050505; color: #d6d3d1; font-family: 'EB Garamond', serif; overflow: hidden; }
        
        /* Fixed UI Layer */
        #ui-root { position: absolute; inset: 0; z-index: 20; pointer-events: none; display: flex; }
        .sidebar { 
            width: 380px; height: 100vh; pointer-events: auto;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-right: 1px solid #222; display: flex; flex-direction: column;
        }
        
        /* 3D Canvas Layer */
        #canvas-container { position: absolute; inset: 0; z-index: 10; }
        
        .glitch-text { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.05em; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; }
        
        input::placeholder { color: #444; font-style: italic; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-root">
        <div class="sidebar p-8">
            <div class="mb-10">
                <h1 class="glitch-text text-5xl text-white mb-1 leading-none">ANATOMLE</h1>
                <div class="flex items-center gap-2">
                    <span class="h-[1px] w-8 bg-emerald-500"></span>
                    <p class="text-[10px] text-stone-500 uppercase tracking-[0.4em] font-bold">Clinical Pathway v24.3</p>
                </div>
            </div>

            <div id="path-container" class="flex-1 overflow-y-auto space-y-4 mb-8 pr-2 custom-scrollbar">
                </div>

            <div class="space-y-6 border-t border-stone-800 pt-8">
                <div class="bg-stone-900/40 p-5 rounded-sm border border-stone-800 flex justify-between items-end">
                    <div>
                        <p class="text-[9px] text-stone-600 uppercase tracking-widest mb-1">Diagnostic Target</p>
                        <h2 id="target-display" class="text-xl text-stone-200 font-bold uppercase tracking-tight">---</h2>
                    </div>
                    <span class="text-emerald-500 text-2xl">ðŸŽ¯</span>
                </div>

                <div class="relative group">
                    <input id="guess-input" type="text" autocomplete="off" placeholder="Identify structure..." 
                        class="w-full bg-transparent border-b border-stone-800 py-4 text-lg text-white outline-none focus:border-emerald-500 transition-all duration-500">
                    <div class="absolute bottom-0 left-0 h-[1px] w-0 bg-emerald-500 group-focus-within:w-full transition-all duration-700"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA SETUP ---
        const TARGET_BONE = "Sacrum"; // Original Target
        const BONE_MAP = {
            "Sacrum": "Sacrum",
            "Femur": "Femurr",
            "Frontal Bone": "Frontal_bone",
            "Mandible": "Mandible_bone",
            "Atlas": "Atlas_(C1)",
            "Tibia": "Tibiar"
        };
        let guessChain = [];

        // --- 3. THE 3D ENGINE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(0, 1.2, 5);
        controls.enableDamping = true;

        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const spot = new THREE.SpotLight(0xffffff, 1);
        spot.position.set(5, 10, 5);
        scene.add(spot);

        // Draco/GLTF Loader
        const draco = new THREE.DRACOLoader();
        draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        const loader = new THREE.GLTFLoader();
        loader.setDRACOLoader(draco);

        let skeleton = null;
        loader.load('./overview-skeleton.glb', (gltf) => {
            skeleton = gltf.scene;
            scene.add(skeleton);
            updateModelVisuals();
        });

        // --- LOGIC INTEGRATION ---
        document.getElementById('target-display').innerText = TARGET_BONE;

        function updateModelVisuals() {
            if (!skeleton) return;
            skeleton.traverse(node => {
                if (node.isMesh) {
                    const guess = guessChain.find(g => BONE_MAP[g.bone] === node.name || (BONE_MAP[g.bone] + 'r') === node.name);
                    
                    if (guess) {
                        node.material = new THREE.MeshStandardMaterial({
                            color: guess.color,
                            emissive: guess.color,
                            emissiveIntensity: 0.3
                        });
                    } else {
                        node.material = new THREE.MeshStandardMaterial({
                            color: 0x1a1a1a,
                            transparent: true,
                            opacity: 0.1,
                            wireframe: true
                        });
                    }
                }
            });
        }

        const input = document.getElementById('guess-input');
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value) {
                const val = input.value.trim();
                let status = { emoji: 'ðŸ§¬', color: 0x3b82f6 }; // Default: Ahead
                
                if (val.toLowerCase() === TARGET_BONE.toLowerCase()) {
                    status = { emoji: 'âœ…', color: 0x10b981 }; // Correct
                } else if (val.toLowerCase().includes('lumbar')) {
                    status = { emoji: 'ðŸ”€', color: 0xf59e0b }; // Swap simulation
                }

                guessChain.push({ bone: val, ...status });
                addUICard(val, status);
                updateModelVisuals();
                input.value = '';
            }
        });

        function addUICard(name, status) {
            const container = document.getElementById('path-container');
            const card = document.createElement('div');
            card.className = "p-4 bg-stone-900/60 border-l-2 border-stone-800 flex justify-between items-center group hover:border-emerald-500 transition-all duration-300";
            card.style.borderLeftColor = '#' + status.color.toString(16);
            card.innerHTML = `
                <span class="text-[11px] uppercase tracking-widest text-stone-300 font-bold">${name}</span>
                <span class="text-lg">${status.emoji}</span>
            `;
            container.prepend(card);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
