<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANATOMLE | Foot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
    * { box-sizing: border-box; }
    body {
        font-family: 'DM Sans', sans-serif;
        background: #fdf6ec;
        color: #2d1f14;
        margin: 0;
        overflow: hidden;
    }
    #cv {
        position: fixed;
        top: 104px;
        left: 0;
        right: 580px;
        bottom: 68px;
        z-index: 10;
        background: radial-gradient(ellipse at 50% 40%, #f5e8d0 0%, #ede0c8 60%, #e4d4b8 100%);
    }
    #ad-slot {
        position: fixed;
        top: 58px;
        right: 0;
        width: 160px;
        bottom: 0;
        z-index: 150;
        background: #fff8f0;
        border-left: 2px solid #e8d5c0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    #ad-slot span {
        font-family: 'DM Sans', sans-serif;
        font-size: 9px;
        color: #c8b8a8;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        writing-mode: vertical-rl;
    }
    #ad-slot .ad-placeholder {
        width: 120px;
        height: 240px;
        border: 2px dashed #e8d5c0;
        border-radius: 8px;
    }
    .scr::-webkit-scrollbar { width: 3px; }
    .scr::-webkit-scrollbar-thumb { background: #e8d5c0; border-radius: 2px; }
    .shake { animation: shake 0.3s ease-in-out; }
    @keyframes shake {
        0%,100% { transform: translateX(0); }
        25%      { transform: translateX(-4px); }
        75%      { transform: translateX(4px); }
    }
</style>
</head>
<body>
<div id="cv"></div>
<div id="ad-slot">
    <div class="ad-placeholder"></div>
    <span>Coming Soon</span>
</div>
<div id="root"></div>

<script>
const FOOT_GRAPH = {
    'Tibia':['Fibula','Talus'],'Fibula':['Tibia','Talus'],
    'Talus':['Tibia','Fibula','Calcaneus','Navicular'],'Calcaneus':['Talus','Cuboid'],
    'Navicular':['Talus','Medial Cuneiform','Intermediate Cuneiform','Lateral Cuneiform'],
    'Cuboid':['Calcaneus','Lateral Cuneiform','Metatarsal IV','Metatarsal V'],
    'Medial Cuneiform':['Navicular','Intermediate Cuneiform','Metatarsal I','Metatarsal II'],
    'Intermediate Cuneiform':['Navicular','Medial Cuneiform','Lateral Cuneiform','Metatarsal II'],
    'Lateral Cuneiform':['Navicular','Intermediate Cuneiform','Cuboid','Metatarsal III','Metatarsal IV'],
    'Metatarsal I':['Medial Cuneiform','Proximal Phalanx I (Foot)'],
    'Metatarsal II':['Medial Cuneiform','Intermediate Cuneiform','Proximal Phalanx II (Foot)'],
    'Metatarsal III':['Lateral Cuneiform','Proximal Phalanx III (Foot)'],
    'Metatarsal IV':['Lateral Cuneiform','Cuboid','Proximal Phalanx IV (Foot)'],
    'Metatarsal V':['Cuboid','Proximal Phalanx V (Foot)'],
    'Proximal Phalanx I (Foot)':['Metatarsal I','Distal Phalanx I (Foot)'],
    'Distal Phalanx I (Foot)':['Proximal Phalanx I (Foot)'],
    'Proximal Phalanx II (Foot)':['Metatarsal II','Middle Phalanx II (Foot)'],
    'Middle Phalanx II (Foot)':['Proximal Phalanx II (Foot)','Distal Phalanx II (Foot)'],
    'Distal Phalanx II (Foot)':['Middle Phalanx II (Foot)'],
    'Proximal Phalanx III (Foot)':['Metatarsal III','Middle Phalanx III (Foot)'],
    'Middle Phalanx III (Foot)':['Proximal Phalanx III (Foot)','Distal Phalanx III (Foot)'],
    'Distal Phalanx III (Foot)':['Middle Phalanx III (Foot)'],
    'Proximal Phalanx IV (Foot)':['Metatarsal IV','Middle Phalanx IV (Foot)'],
    'Middle Phalanx IV (Foot)':['Proximal Phalanx IV (Foot)','Distal Phalanx IV (Foot)'],
    'Distal Phalanx IV (Foot)':['Middle Phalanx IV (Foot)'],
    'Proximal Phalanx V (Foot)':['Metatarsal V','Middle Phalanx V (Foot)'],
    'Middle Phalanx V (Foot)':['Proximal Phalanx V (Foot)','Distal Phalanx V (Foot)'],
    'Distal Phalanx V (Foot)':['Middle Phalanx V (Foot)'],
};
const FOOT_ALL = Object.keys(FOOT_GRAPH);
const FOOT_TOTAL = FOOT_ALL.length;
const FOOT_B2M = {
    'Tibia':'Tibiar','Fibula':'Fibular','Talus':'Talusr','Calcaneus':'Calcaneusr',
    'Navicular':'Navicular_boner','Cuboid':'Cuboid_boner',
    'Medial Cuneiform':'Medial_cuneiform_boner',
    'Intermediate Cuneiform':'Intermediate_cuneiform_boner',
    'Lateral Cuneiform':'Lateral_cuneiform_boner',
    'Metatarsal I':'First_metatarsal_boner','Metatarsal II':'Second_metatarsal_boner',
    'Metatarsal III':'Third_metatarsal_boner','Metatarsal IV':'Fourth_metatarsal_boner',
    'Metatarsal V':'Fifth_metatarsal_boner',
    'Proximal Phalanx I (Foot)':'Proximal_phalanx_of_first_finger_of_footr',
    'Distal Phalanx I (Foot)':'Distal_phalanx_of_first_finger_of_footr',
    'Proximal Phalanx II (Foot)':'Proximal_phalanx_of_second_finger_of_footr',
    'Middle Phalanx II (Foot)':'Middle_phalanx_of_second_finger_of_footr',
    'Distal Phalanx II (Foot)':'Distal_phalanx_of_second_finger_of_footr',
    'Proximal Phalanx III (Foot)':'Proximal_phalanx_of_third_finger_of_footr',
    'Middle Phalanx III (Foot)':'Middle_phalanx_of_third_finger_of_footr',
    'Distal Phalanx III (Foot)':'Distal_phalanx_of_third_finger_of_footr',
    'Proximal Phalanx IV (Foot)':'Proximal_phalanx_of_fourth_finger_of_footr',
    'Middle Phalanx IV (Foot)':'Middle_phalanx_of_fourth_finger_of_footr',
    'Distal Phalanx IV (Foot)':'Distal_phalanx_of_fourth_finger_of_footr',
    'Proximal Phalanx V (Foot)':'Proximal_phalanx_of_fifth_finger_of_footr',
    'Middle Phalanx V (Foot)':'Middle_phalanx_of_fifth_finger_of_footr',
    'Distal Phalanx V (Foot)':'Distal_phalanx_of_fifth_finger_of_footr',
};
</script>

<script src="../js/3d/footEngine.js"></script>
<script src="../js/ui/floodFillUI.js"></script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

function FootGame() {
    const [guessed, setGuessed] = useState(() => new Set());
    const [bad, setBad] = useState([]); // not-adjacent attempts (can retry)
    const [left, setLeft] = useState((FOOT_TOTAL - 1) + 5);
    const [max, setMax] = useState((FOOT_TOTAL - 1) + 5);
    const [input, setInput] = useState('');
    const [selIdx, setSelIdx] = useState(-1);
    const [phase, setPhase] = useState('playing');
    const [start, setStart] = useState('');
    const [reveal, setReveal] = useState(false);

    const startNew = useCallback(() => {
        const total = (FOOT_TOTAL - 1) + 5;
        const newStart = FOOT_ALL[Math.floor(Math.random() * FOOT_ALL.length)];
        setStart(newStart);
        setGuessed(new Set([newStart]));
        setBad([]); setLeft(total); setMax(total);
        setInput(''); setSelIdx(-1); setPhase('playing'); setReveal(false);
        try { window.reset3D && window.reset3D(); } catch(e) {}
    }, []);

    useEffect(() => { startNew(); }, []);

    const frontier = useMemo(() => {
        const f = new Set();
        guessed.forEach(b => { (FOOT_GRAPH[b]||[]).forEach(n => { if(!guessed.has(n)) f.add(n); }); });
        return f;
    }, [guessed]);

    useEffect(() => {
        const h = [];
        guessed.forEach(b => h.push({name:b, type: b===start ? 'start' : 'found'}));
        if (reveal && phase==='lost') FOOT_ALL.forEach(b => { if(!guessed.has(b)) h.push({name:b,type:'reveal'}); });
        bad.forEach(b => h.push({name:b,type:'bad'}));
        try { window.update3D && window.update3D(h); } catch(e) {}
    }, [guessed, bad, reveal, phase]);

    const suggestions = useMemo(() => {
        if (!input.trim()) return [];
        return FOOT_ALL.filter(b =>
            b.toLowerCase().includes(input.toLowerCase()) &&
            !guessed.has(b)
        ).slice(0, 7);
    }, [input, guessed, bad]);

    useEffect(() => { setSelIdx(-1); }, [suggestions.length]);

    const submit = useCallback((g) => {
        if (phase !== 'playing' || !g || !FOOT_ALL.includes(g) || guessed.has(g)) return;
        const nl = left - 1; setLeft(nl);
        if (frontier.has(g)) {
            const ng = new Set(guessed); ng.add(g); setGuessed(ng);
            if (ng.size === FOOT_TOTAL) { setPhase('won'); setInput(''); return; }
            if (nl <= 0) { setPhase('lost'); setInput(''); return; }
        } else {
            setBad(p => p.includes(g) ? p : [g, ...p]); // track for display, bone stays guessable
            if (nl <= 0) { setPhase('lost'); setInput(''); return; }
        }
        setInput(''); setSelIdx(-1);
    }, [phase, guessed, frontier, left, bad]);

    const handleKey = (ev) => {
        if (ev.key === 'ArrowDown') { ev.preventDefault(); setSelIdx(i => Math.min(i+1, suggestions.length-1)); }
        else if (ev.key === 'ArrowUp') { ev.preventDefault(); setSelIdx(i => Math.max(i-1, 0)); }
        else if (ev.key === 'Enter') {
            if (selIdx >= 0 && suggestions[selIdx]) submit(suggestions[selIdx]);
            else if (suggestions.length === 1) submit(suggestions[0]);
        }
        else if (ev.key === 'Escape') { setInput(''); setSelIdx(-1); }
    };

    return (
        <window.FloodFillUI
            gameTitle="ðŸ¦¶ Foot"
            state={{ start: start, total: FOOT_TOTAL, guessed, bad, left, max, input, selIdx, phase, reveal, suggestions }}
            handlers={{
                onInputChange: ev => setInput(ev.target.value),
                onKeyDown: handleKey,
                onSubmit: submit,
                onNewGame: startNew,
                onReveal: () => setReveal(true)
            }}
        />
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<FootGame />);
</script>
</body>
</html>
